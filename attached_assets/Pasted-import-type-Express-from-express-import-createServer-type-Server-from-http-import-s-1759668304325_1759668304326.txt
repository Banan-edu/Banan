import type { Express } from "express";
import { createServer, type Server } from "http";
import { storage } from "./storage";
import { insertRegistrationSchema, insertContactMessageSchema } from "@shared/schema";
import { z } from "zod";
import nodemailer from "nodemailer";

// Email configuration for Gmail
const transporter = nodemailer.createTransport({
  service: 'gmail', // Use predefined Gmail service
  auth: {
    user: process.env.SMTP_USER,
    pass: process.env.SMTP_PASS, // This should be an App Password for Gmail
  },
  tls: {
    rejectUnauthorized: false
  }
});

// Verify connection configuration on startup
transporter.verify((error, success) => {
  if (error) {
    console.error('âŒ SMTP configuration error:', error.message);
    console.log('ğŸ’¡ Tip: For Gmail, you need an App Password. Go to Google Account Settings > Security > 2-Step Verification > App passwords');
  } else {
    console.log('âœ… Gmail SMTP server is ready to send emails');
  }
});

export async function registerRoutes(app: Express): Promise<Server> {
  // Registration endpoint
  app.post("/api/register", async (req, res) => {
    try {
      const validatedData = insertRegistrationSchema.parse(req.body);
      
      // Store registration in database first
      const registration = await storage.createRegistration(validatedData);
      
      // Try to send email notification (non-blocking)
      let emailSent = false;
      try {
        const emailContent = `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; direction: rtl;">
            <h2 style="color: #2563EB; text-align: center;">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¨Ù†Ø§Ù†</h2>
            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin: 20px 0;">
              <h3 style="color: #1e40af; margin-top: 0;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…:</h3>
              <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${validatedData.fullName}</p>
              <p><strong>Ø§Ù„Ø¬Ù†Ø³:</strong> ${validatedData.gender === 'male' ? 'Ø°ÙƒØ±' : 'Ø£Ù†Ø«Ù‰'}</p>
              <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</strong> ${validatedData.dateOfBirth}</p>
              <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${validatedData.phone}</p>
              <p><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> ${validatedData.email}</p>
              <p><strong>Ø³Ø±Ø¹Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong> ${validatedData.currentTypingSpeed || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} ÙƒÙ„Ù…Ø©/Ø¯Ù‚ÙŠÙ‚Ø©</p>
              <p><strong>Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ø±ØºÙˆØ¨Ø©:</strong> ${validatedData.desiredTypingSpeed || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} ÙƒÙ„Ù…Ø©/Ø¯Ù‚ÙŠÙ‚Ø©</p>
              ${validatedData.additionalInfo ? `<p><strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:</strong> ${validatedData.additionalInfo}</p>` : ''}
            </div>
            <p style="text-align: center; color: #64748b;">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù…Ù† Ù…Ù†ØµØ© Ø¨Ù†Ø§Ù† Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</p>
          </div>
        `;
        
        await transporter.sendMail({
          from: process.env.SMTP_USER,
          to: "hzalraee@inspiration.edu.sa",
          cc: "info.banan@inspiration.edu.sa",
          subject: "ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¨Ù†Ø§Ù† - Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ 2025",
          html: emailContent,
        });
        emailSent = true;
      } catch (emailError) {
        console.error("Email sending failed:", emailError);
        // Continue without failing the registration
      }
      
      res.json({ 
        success: true, 
        message: emailSent ? "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­" : "ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ (Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ø§Ø­Ù‚Ø§Ù‹)",
        registration: registration,
        emailSent: emailSent
      });
    } catch (error) {
      console.error("Registration error:", error);
      
      if (error instanceof z.ZodError) {
        return res.status(400).json({ 
          success: false, 
          message: "Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©", 
          errors: error.errors 
        });
      }
      
      res.status(500).json({ 
        success: false, 
        message: "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…" 
      });
    }
  });

  

  // Contact form endpoint
  app.post("/api/contact", async (req, res) => {
    try {
      const validatedData = insertContactMessageSchema.parse(req.body);
      
      // Store contact message in database first
      const contactMessage = await storage.createContactMessage(validatedData);
      
      // Try to send email (non-blocking)
      let emailSent = false;
      try {
        const emailContent = `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <h2 style="color: #2563EB;">Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø§Ù†</h2>
            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin: 20px 0;">
              <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${validatedData.name}</p>
              <p><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> ${validatedData.email}</p>
              <p><strong>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:</strong> ${validatedData.subject}</p>
              <p><strong>Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</strong></p>
              <div style="background: white; padding: 15px; border-radius: 4px; margin-top: 10px;">
                ${validatedData.message}
              </div>
            </div>
          </div>
        `;
        
        await transporter.sendMail({
          from: process.env.SMTP_USER,
          to: "hzalraee@inspiration.edu.sa",
          subject: `Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø§Ù†: ${validatedData.subject}`,
          html: emailContent,
          replyTo: validatedData.email,
        });
        emailSent = true;
      } catch (emailError) {
        console.error("Contact email sending failed:", emailError);
        // important 
        // Continue without failing the contact form
      }
      
      res.json({ 
        success: true, 
        message: emailSent ? "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­" : "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø³Ø§Ù„ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­ (Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹)",
        contactMessage: contactMessage,
        emailSent: emailSent
      });
    } catch (error) {
      console.error("Contact form error:", error);
      
      if (error instanceof z.ZodError) {
        return res.status(400).json({ 
          success: false, 
          message: "Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©", 
          errors: error.errors 
        });
      }
      
      res.status(500).json({ 
        success: false, 
        message: "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©" 
      });
    }
  });

  const httpServer = createServer(app);
  return httpServer;
}
